<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Formulir Pemesanan — Modern</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
    :root{
      --accent-start: 53 80 255; /* indigo-500 */
      --accent-end: 124 58 237;  /* violet-600 */
    }
    body{font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial;background:linear-gradient(180deg, #f8fafc 0%, #eef2ff 100%);}    
    input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button{-webkit-appearance:none;margin:0}
    input[type=number]{-moz-appearance:textfield;appearance:textfield}
    :focus{outline: none}
    .focus-ring:focus{box-shadow:0 8px 24px rgba(0,0,0,0.06), 0 0 0 6px rgba(var(--accent-start),0.08);}    
    .card-accent{background:linear-gradient(135deg, rgba(var(--accent-start),0.06), rgba(var(--accent-end),0.04)); border:1px solid rgba(99,102,241,0.06)}
    .btn-accent{background:linear-gradient(90deg, rgb(var(--accent-start)), rgb(var(--accent-end)));}
    .prod-icon{width:48px;height:48px;border-radius:12px;display:flex;align-items:center;justify-content:center}
    .hidden-by-js{display:none !important}
    pre.confirm-text{white-space:pre-wrap; text-align:left;}
  </style>
</head>
<body class="min-h-screen p-6">
  <div class="max-w-6xl mx-auto">
    <header class="mb-8 flex items-center justify-between">
      <div class="flex items-center gap-4">
        <div class="w-12 h-12 rounded-xl prod-icon" style="background:linear-gradient(135deg, rgba(var(--accent-start),0.15), rgba(var(--accent-end),0.12)); box-shadow: 0 8px 24px rgba(99,102,241,0.08);">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-indigo-700" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M3 7v10a2 2 0 0 0 2 2h14" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path><path d="M7 7h10v-3a2 2 0 0 0-2-2H9a2 2 0 0 0-2 2v3z" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path></svg>
        </div>
        <div>
          <h1 class="text-2xl font-semibold text-gray-800">Formulir Pemesanan</h1>
          <p class="text-sm text-gray-500">Pilih produk, atur jumlah, lalu kirim pesanan Anda.</p>
        </div>
      </div>
    </header>

    <main class="grid grid-cols-1 lg:grid-cols-3 gap-8">
      <section class="lg:col-span-2">
        <form id="orderForm" class="space-y-8 bg-white rounded-2xl p-6 shadow-lg card-accent" novalidate>

          <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
            <div>
              <label for="nama" class="block text-sm font-medium text-gray-700">Nama <span class="text-red-500">*</span></label>
              <input id="nama" name="nama" required class="mt-2 w-full p-3 border border-gray-200 rounded-lg focus-ring" placeholder="Nama lengkap" />
            </div>
            <div>
              <label for="email" class="block text-sm font-medium text-gray-700">Email <span class="text-red-500">*</span></label>
              <input id="email" name="email" type="email" required class="mt-2 w-full p-3 border border-gray-200 rounded-lg focus-ring" placeholder="nama@contoh.com"/>
            </div>
          </div>

          <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
            <div>
              <label for="no_wa" class="block text-sm font-medium text-gray-700">No. WA <span class="text-red-500">*</span></label>
              <input id="no_wa" name="no_wa" type="tel" required class="mt-2 w-full p-3 border border-gray-200 rounded-lg focus-ring" placeholder="08xxxxxxxxxx"/>
            </div>
            <div>
              <label for="kota" class="block text-sm font-medium text-gray-700">Kota</label>
              <input id="kota" name="kota" class="mt-2 w-full p-3 border border-gray-200 rounded-lg focus-ring" placeholder="Kota tujuan"/>
            </div>
          </div>

          <div>
            <label for="alamat" class="block text-sm font-medium text-gray-700">Alamat Pengiriman <span class="text-red-500">*</span></label>
            <textarea id="alamat" name="alamat" rows="4" required class="mt-2 w-full p-3 border border-gray-200 rounded-lg focus-ring" placeholder="Alamat lengkap (jalan, RT/RW, kode pos)"></textarea>
          </div>

          <hr class="border-dashed" />

          <div>
            <h2 class="text-lg font-semibold text-gray-800 mb-3">Pilihan Produk</h2>
            <p class="text-sm text-gray-500 mb-4">Atur jumlah produk yang ingin dipesan. Gunakan tombol + / - untuk pengalaman yang nyaman.</p>

            <div id="product-list" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
          </div>

          <!-- Metode Pembayaran (selalu ada) -->
          <div id="payment-section">
            <label class="block text-lg font-semibold text-gray-800 mb-3">Metode Pembayaran <span class="text-red-500">*</span></label>
            <div id="payment-options" class="mt-2 space-y-3">
              <label class="flex items-center gap-3 p-3 border border-gray-200 rounded-lg transition-all">
                <input id="pay_cod" name="metode_pembayaran" type="radio" value="COD (Bayar di Tempat)" class="h-4 w-4 text-indigo-600 border-gray-300 focus:ring-indigo-500">
                <span class="block text-sm font-medium text-gray-700">COD (Bayar di Tempat)</span>
              </label>
              <label class="flex items-center gap-3 p-3 border border-gray-200 rounded-lg transition-all">
                <input id="pay_transfer" name="metode_pembayaran" type="radio" value="Transfer Bank" class="h-4 w-4 text-indigo-600 border-gray-300 focus:ring-indigo-500">
                <span class="block text-sm font-medium text-gray-700">Transfer Bank</span>
              </label>
              <label class="flex items-center gap-3 p-3 border border-gray-200 rounded-lg transition-all">
                <input id="pay_ewallet" name="metode_pembayaran" type="radio" value="E-Wallet (OVO/GoPay)" class="h-4 w-4 text-indigo-600 border-gray-300 focus:ring-indigo-500">
                <span class="block text-sm font-medium text-gray-700">E-Wallet (OVO/GoPay)</span>
              </label>
            </div>
          </div>

          <div class="flex items-center justify-between">
            <div class="text-gray-600">Catatan (opsional)</div>
            <div class="text-sm text-gray-500">Harga sudah termasuk pajak</div>
          </div>

          <div class="hidden lg:flex justify-end">
            <button id="submitBtn" type="button" class="px-6 py-3 rounded-lg text-white font-semibold shadow-lg btn-accent">Kirim Pesanan</button>
          </div>

          <div class="lg:hidden">
            <button id="mobileSubmit" type="button" class="w-full px-6 py-3 rounded-lg text-white font-semibold shadow-lg btn-accent">Kirim Pesanan</button>
          </div>

        </form>
      </section>

      <aside class="sticky top-6">
        <div class="bg-white rounded-2xl p-5 shadow-lg card-accent">
          <h3 class="text-lg font-semibold text-gray-800">Ringkasan Pesanan</h3>
          <div class="mt-4 space-y-3" id="summary-items">
            <p class="text-sm text-gray-500">Belum ada produk dipilih.</p>
          </div>

          <div class="mt-6 border-t pt-4">
            <div class="flex items-center justify-between">
              <div class="text-sm text-gray-600">Subtotal</div>
              <div id="total-price" class="text-xl font-bold text-indigo-600">Rp0</div>
            </div>
            <div class="mt-4 grid grid-cols-2 gap-3">
              <button id="resetBtn" class="px-3 py-2 border rounded-lg text-sm">Reset</button>
              <button id="openModalBtn" class="px-3 py-2 rounded-lg text-sm text-white btn-accent">Pratinjau & Kirim</button>
            </div>
          </div>
        </div>
      </aside>
    </main>

    <!-- Success Modal (confirmation before sending) -->
    <div id="success-modal" class="fixed inset-0 bg-black/40 hidden items-center justify-center p-6 z-50">
      <div class="bg-white rounded-2xl p-6 max-w-md w-full shadow-2xl text-center">
        <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-green-100 mx-auto mb-4">
          <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
        </div>
        <h4 class="text-xl font-semibold text-gray-800">Konfirmasi Pesanan</h4>
        <p id="confirm-summary" class="text-gray-600 mt-2">Periksa kembali pesanan Anda sebelum mengirim.</p>
        <div class="mt-6 grid grid-cols-2 gap-3">
          <button id="closeModalBtn" class="px-3 py-2 border rounded-lg">Batal</button>
          <button id="modalOkBtn" class="px-3 py-2 rounded-lg text-white btn-accent">Kirim Sekarang</button>
        </div>
      </div>
    </div>

    <!-- Error Modal -->
    <div id="error-modal" class="fixed inset-0 bg-black/40 hidden items-center justify-center p-6 z-50">
      <div class="bg-white rounded-2xl p-6 max-w-md w-full shadow-2xl text-center">
        <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-red-100 mx-auto mb-4">
          <svg class="w-8 h-8 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
        </div>
        <h4 class="text-xl font-semibold text-gray-800">Gagal Mengirim!</h4>
        <p id="error-message" class="text-gray-600 mt-2">Terjadi kesalahan. Silakan coba lagi nanti.</p>
        <div class="mt-6">
          <button id="closeErrorModalBtn" class="w-full px-3 py-2 border rounded-lg">Tutup</button>
        </div>
      </div>
    </div>

  </div>

  <script>
    // === CONFIG: Google Apps Script URL (user requested to keep this exact URL) ===
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbys87AzeEcNEFuq4d0y0J3nZJLRM08h3twlBXYiW73Fwg75qsJ8gz9aYeEzA-rA_I95/exec";

    const products = [
      { id: 'br001', name: 'BR001 – HP', price: 1000000, formattedPrice: 'Rp1.000.000', icon: '<svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor"><rect x="2" y="5" width="20" height="14" rx="2" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></rect><path d="M8 21h8" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path></svg>' },
      { id: 'br002', name: 'BR002 – TV', price: 1500000, formattedPrice: 'Rp1.500.000', icon: '<svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor"><rect x="2" y="3" width="20" height="14" rx="2" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></rect><path d="M8 21h8" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path></svg>' },
      { id: 'br003', name: 'BR003 – Mouse', price: 30000, formattedPrice: 'Rp30.000', icon: '<svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M12 2c2.21 0 4 1.79 4 4v12c0 2.21-1.79 4-4 4s-4-1.79-4-4V6c0-2.21 1.79-4 4-4z" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path></svg>' },
      { id: 'br004', name: 'BR004 – Keyboard', price: 200000, formattedPrice: 'Rp200.000', icon: '<svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor"><rect x="2" y="5" width="20" height="14" rx="2" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></rect><path d="M6 10h.01M10 10h.01M14 10h.01M18 10h.01" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path></svg>' },
      { id: 'br005', name: 'BR005 – Speaker', price: 150000, formattedPrice: 'Rp150.000', icon: '<svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M11 5l-6 6h4v6l6-6h-4z" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path></svg>' }
    ];

    const productListEl = document.getElementById('product-list');
    const totalPriceEl = document.getElementById('total-price');
    const summaryItemsEl = document.getElementById('summary-items');
    const orderForm = document.getElementById('orderForm');
    const successModal = document.getElementById('success-modal');
    const errorModal = document.getElementById('error-modal');
    const errorMessageEl = document.getElementById('error-message');
    const openModalBtn = document.getElementById('openModalBtn');
    const resetBtn = document.getElementById('resetBtn');
    const submitBtn = document.getElementById('submitBtn');
    const mobileSubmit = document.getElementById('mobileSubmit');
    const closeModalBtn = document.getElementById('closeModalBtn');
    const modalOkBtn = document.getElementById('modalOkBtn');
    const closeErrorModalBtn = document.getElementById('closeErrorModalBtn');

    function formatCurrency(amount){
      return new Intl.NumberFormat('id-ID', {style:'currency',currency:'IDR',minimumFractionDigits:0}).format(amount).replace(/,00$/, '');
    }

    function renderProducts(){
      productListEl.innerHTML = '';
      products.forEach(p => {
        const wrap = document.createElement('div');
        wrap.className = 'flex items-center gap-4 p-3 border border-gray-100 rounded-xl shadow-sm bg-white';
        wrap.innerHTML = `
          <div class="prod-icon" style="background:linear-gradient(135deg, rgba(var(--accent-start),0.06), rgba(var(--accent-end),0.04));">
            ${p.icon}
          </div>
          <div class="flex-1 min-w-0">
            <div class="flex items-baseline justify-between">
              <div>
                <div class="font-medium text-gray-800">${p.name}</div>
                <div class="text-xs text-gray-500">${p.formattedPrice} / pcs</div>
              </div>
            </div>
          </div>
          <div class="flex items-center gap-2">
            <button type="button" class="decr px-2 py-1 rounded-md border shadow-sm active:shadow-inner active:bg-gray-100 transition-all duration-100" data-id="${p.id}">-</button>
            <input type="number" min="0" value="0" class="product-input w-16 text-center p-1 border rounded-md" data-price="${p.price}" id="${p.id}" />
            <button type="button" class="incr px-2 py-1 rounded-md border shadow-sm active:shadow-inner active:bg-gray-100 transition-all duration-100" data-id="${p.id}">+</button>
          </div>
        `;
        productListEl.appendChild(wrap);
      });

      productListEl.querySelectorAll('.incr').forEach(btn => btn.addEventListener('click', e=> changeQty(e,1)));
      productListEl.querySelectorAll('.decr').forEach(btn => btn.addEventListener('click', e=> changeQty(e,-1)));
      productListEl.querySelectorAll('.product-input').forEach(inp => inp.addEventListener('input', updateTotal));
    }

    function changeQty(e, delta){
      const id = e.currentTarget.dataset.id;
      const input = document.getElementById(id);
      const current = parseInt(input.value) || 0;
      const next = Math.max(0, current + delta);
      input.value = next;
      updateTotal();
    }

    function updateTotal(){
      const inputs = document.querySelectorAll('.product-input');
      let total = 0;
      let any = false;
      summaryItemsEl.innerHTML = '';
      inputs.forEach(inp => {
        const price = parseFloat(inp.dataset.price) || 0;
        const qty = parseInt(inp.value) || 0;
        if(qty > 0){
          any = true;
          const product = products.find(p=>p.id === inp.id);
          const sub = price * qty;
          total += sub;

          const row = document.createElement('div');
          row.className = 'flex items-center justify-between';
          row.dataset.id = product.id;
          row.dataset.name = product.name;
          row.dataset.qty = qty;
          row.dataset.subtotal = sub;
          row.innerHTML = `<div class="text-sm text-gray-700 truncate">${product.name} × ${qty}</div><div class="text-sm font-medium">${formatCurrency(sub)}</div>`;
          summaryItemsEl.appendChild(row);
        }
      });

      if(!any){
        summaryItemsEl.innerHTML = '<p class="text-sm text-gray-500">Belum ada produk dipilih.</p>';
      }

      totalPriceEl.textContent = formatCurrency(total);
      localStorage.setItem('cart', JSON.stringify(Array.from(inputs).map(i=>({id:i.id,qty: i.value}))));
    }

    resetBtn.addEventListener('click', ()=>{
      document.querySelectorAll('.product-input').forEach(i=>i.value = 0);
      updateTotal();
    });

    // Open confirmation modal (build summary)
    function openConfirmation(){
      const items = Array.from(summaryItemsEl.querySelectorAll('[data-id]'));
      if(items.length === 0){
        showError('Pilih minimal satu produk sebelum mengirim pesanan.');
        return;
      }

      // Build short summary
      const lines = items.map(it => `${it.dataset.name} × ${it.dataset.qty} — ${formatCurrency(it.dataset.subtotal)}`);
      const totalText = document.getElementById('total-price').textContent || '';
      document.getElementById('confirm-summary').textContent = lines.join('\n') + '\nTotal: ' + totalText;
      successModal.classList.remove('hidden');
      successModal.classList.add('flex');
    }

    openModalBtn.addEventListener('click', openConfirmation);
    // Submit buttons open confirmation instead of submitting directly
    submitBtn.addEventListener('click', openConfirmation);
    mobileSubmit.addEventListener('click', openConfirmation);

    closeModalBtn.addEventListener('click', ()=>{successModal.classList.add('hidden');successModal.classList.remove('flex')});

    modalOkBtn.addEventListener('click', function(){
      // When user confirms, perform final validation and submit
      successModal.classList.add('hidden');
      successModal.classList.remove('flex');
      submitOrder();
    });

    closeErrorModalBtn.addEventListener('click', ()=>{errorModal.classList.add('hidden');errorModal.classList.remove('flex')});

    // Final validation before sending
    function validateFormFinal(){
      const required = ['nama','email','no_wa','alamat'];
      for(const id of required){
        const el = document.getElementById(id);
        if(!el.value.trim()){
          el.focus();
          showError('Mohon lengkapi: ' + id);
          return false;
        }
      }
      const payment = document.querySelector('input[name="metode_pembayaran"]:checked');
      if(!payment){
        showError('Pilih metode pembayaran.');
        return false;
      }
      // ensure there's at least one product
      const items = Array.from(summaryItemsEl.querySelectorAll('[data-id]'));
      if(items.length === 0){
        showError('Pilih minimal satu produk.');
        return false;
      }
      return true;
    }

    // Submit order to Google Apps Script
    function submitOrder(){
      if(!validateFormFinal()) return;

      setLoading(true);

      const formData = new FormData(orderForm);
      const order = {};
      for(const [k,v] of formData.entries()) order[k]=v;
      order.cart = Array.from(summaryItemsEl.querySelectorAll('[data-id]')).map(it => ({
        id: it.dataset.id,
        name: it.dataset.name,
        qty: Number(it.dataset.qty),
        subtotal: Number(it.dataset.subtotal)
      }));

      fetch(SCRIPT_URL, {
        method: 'POST',
        mode: 'cors',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(order)
      })
      .then(res => res.json().catch(()=>({status: 'ok'})))
      .then(data => {
        setLoading(false);
        // assume success if no explicit error
        if(!data || data.status === 'success' || data.status === 'ok'){
          // show simple success alert / modal
          alert('Pesanan berhasil dikirim. Terima kasih!');
          orderForm.reset();
          document.querySelectorAll('.product-input').forEach(i=>i.value=0);
          updateTotal();
        } else {
          showError(data.message || 'Server mengembalikan error.');
        }
      })
      .catch(err => {
        setLoading(false);
        showError('Gagal mengirim: ' + (err.message || err));
      });
    }

    function setLoading(flag){
      submitBtn.disabled = flag;
      mobileSubmit.disabled = flag;
      submitBtn.textContent = flag ? 'Mengirim...' : 'Kirim Pesanan';
      mobileSubmit.textContent = flag ? 'Mengirim...' : 'Kirim Pesanan';
    }

    function showError(msg){
      errorMessageEl.textContent = msg;
      errorModal.classList.remove('hidden');
      errorModal.classList.add('flex');
    }

    // safe init
    renderProducts();
    updateTotal();

    window.addEventListener('DOMContentLoaded', ()=>{
      try{
        const cart = JSON.parse(localStorage.getItem('cart')||'[]');
        cart.forEach(item=>{
          const el = document.getElementById(item.id);
          if(el) el.value = item.qty || 0;
        });
        updateTotal();
      }catch(e){ console.warn(e); }
    });
  </script>
</body>
</html>
